@Library('Shared') _

pipeline {
    agent any

    parameters {
        string(name: 'DOCKER_TAG', defaultValue: '', description: 'Tag passed from CI Job')
        string(name: 'SERVICE_NAME', defaultValue: 'backend', description: 'backend or frontend')
    }

    environment {
        GIT_URL          = "https://github.com/rupesh-hub/FitVerse-2026-01-01.git"
        GIT_BRANCH       = "main"
        DOCKERHUB_USER   = "rupesh1997"
        GIT_CRED_ID      = "git-ssh-cred"
        TARGET_NS        = "fitverse"
    }

    stages {
        stage('Checkout Manifests') {
            steps {
                checkoutRepository(env.GIT_URL, env.GIT_BRANCH, env.GIT_CRED_ID)
            }
        }

        stage('Update Manifests') {
            steps {
                script {
                    if (!params.DOCKER_TAG) { error "DOCKER_TAG is missing!" }
                    updateManifests(
                        serviceName: params.SERVICE_NAME,
                        version: params.DOCKER_TAG,
                        dockerUser: env.DOCKERHUB_USER,
                        gitCredentialsId: env.GIT_CRED_ID
                    )
                }
            }
        }

        stage('Deploy: Helm (Kubernetes)') {
            steps {
                withCredentials([file(credentialsId: 'k8s-config', variable: 'KUBECONFIG_FILE')]) {
                    script {
                        echo "Deploying ${params.SERVICE_NAME} to Namespace: ${env.TARGET_NS}..."

                        withEnv(["HTTP_PROXY=", "http_proxy=", "HTTPS_PROXY=", "https_proxy=", "NO_PROXY=", "no_proxy="]) {
                            sh '''
                                # 1. Clean up unmanaged namespace to avoid ownership errors
                                if kubectl --kubeconfig $KUBECONFIG_FILE get namespace $TARGET_NS >/dev/null 2>&1; then
                                    if ! kubectl --kubeconfig $KUBECONFIG_FILE get namespace $TARGET_NS -o jsonpath='{.metadata.labels.app\\.kubernetes\\.io/managed-by}' | grep -q "Helm"; then
                                        echo "Found unmanaged namespace. Deleting for clean Helm install..."
                                        kubectl --kubeconfig $KUBECONFIG_FILE delete namespace $TARGET_NS --wait=true
                                    fi
                                fi

                                # 2. Helm Deployment
                                helm upgrade --install fitverse-$SERVICE_NAME ./helm \
                                    --namespace $TARGET_NS \
                                    --create-namespace \
                                    --set ${SERVICE_NAME}.image.tag=$DOCKER_TAG \
                                    --kubeconfig $KUBECONFIG_FILE \
                                    --rollback-on-failure \
                                    --timeout 5m
                            '''
                        }
                    }
                }
            }
        }

        stage('Verify Deployment') {
            steps {
                withCredentials([file(credentialsId: 'k8s-config', variable: 'KUBECONFIG_FILE')]) {
                    sh '''
                        echo "--- Current Status in ${TARGET_NS} ---"
                        kubectl --kubeconfig $KUBECONFIG_FILE get pods,svc,networkpolicy -n $TARGET_NS
                    '''
                }
            }
        }
    }

    post {
        always { cleanWs() }
        success { echo "Deployment of version ${params.DOCKER_TAG} successful!" }
    }
}