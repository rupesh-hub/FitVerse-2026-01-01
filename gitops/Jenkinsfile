@Library('Shared') _

pipeline {
    agent any

    parameters {
        string(name: 'FRONTEND_IMAGE_TAG', defaultValue: 'latest', description: 'Frontend image tag.')
        string(name: 'BACKEND_IMAGE_TAG', defaultValue: 'latest', description: 'Backend image tag.')
    }

    environment {
        GIT_URL          = "https://github.com/rupesh-hub/FitVerse-2026-01-01.git"
        GIT_BRANCH       = "main"
        GIT_CRED_ID      = "git-ssh-cred"
        TARGET_NS        = "fitverse"
    }

    stages {
        stage('Checkout repository') {
            steps {
                checkoutRepository(env.GIT_URL, env.GIT_BRANCH, env.GIT_CRED_ID)
            }
        }

        stage('Update manifests') {
            steps {
                script {
                    updateManifests(
                        gitCredentialsId: env.GIT_CRED_ID,
                        services: [
                            [
                                dockerName: 'fitverse-backend',
                                helmName: 'backend',
                                tag: params.BACKEND_IMAGE_TAG
                            ],
                            [
                                dockerName: 'fitverse-frontend',
                                helmName: 'frontend',
                                tag: params.FRONTEND_IMAGE_TAG
                            ]
                        ]
                    )
                }
            }
        }

        stage('Deploy: Helm') {
            steps {
                withCredentials([file(credentialsId: 'k8s-config', variable: 'KUBECONFIG_FILE')]) {
                    sh """
                        # We use the Helm Keys here (backend and frontend)
                        helm upgrade --install fitverse ./helm \
                            --namespace ${env.TARGET_NS} \
                            --set backend.image.tag=${params.BACKEND_IMAGE_TAG} \
                            --set frontend.image.tag=${params.FRONTEND_IMAGE_TAG} \
                            --kubeconfig \$KUBECONFIG_FILE
                    """
                }
            }
        }

        stage('Deploy: Helm (Kubernetes)') {
            steps {
                withCredentials([file(credentialsId: 'k8s-config', variable: 'KUBECONFIG_FILE')]) {
                    script {
                        echo "Deploying FitVerse to Namespace: ${env.TARGET_NS}..."

                        sh """#!/bin/bash
                            # 1. Namespace Management
                            if kubectl --kubeconfig \$KUBECONFIG_FILE get namespace ${env.TARGET_NS} >/dev/null 2>&1; then
                                MANAGED_BY=\$(kubectl --kubeconfig \$KUBECONFIG_FILE get namespace ${env.TARGET_NS} -o jsonpath='{.metadata.labels.app\\.kubernetes\\.io/managed-by}' || echo "none")
                                if [ "\$MANAGED_BY" != "Helm" ] && [ "\$MANAGED_BY" != "none" ]; then
                                    echo "Warning: Namespace exists but managed by \$MANAGED_BY"
                                fi
                            fi

                            # 2. Helm Deployment
                            # We use --set to ensure the specific tags from parameters are applied even if values.yaml update failed
                            helm upgrade --install fitverse ./helm \
                                --namespace ${env.TARGET_NS} \
                                --create-namespace \
                                --set frontend.image.tag=${params.FRONTEND_IMAGE_TAG} \
                                --set backend.image.tag=${params.BACKEND_IMAGE_TAG} \
                                --kubeconfig \$KUBECONFIG_FILE \
                                --rollback-on-failure \
                                --timeout 5m
                        """
                    }
                }
            }
        }

        stage('Verify Deployment') {
            steps {
                withCredentials([file(credentialsId: 'k8s-config', variable: 'KUBECONFIG_FILE')]) {
                    sh """
                        echo "--- Current Status in ${env.TARGET_NS} ---"
                        kubectl --kubeconfig \$KUBECONFIG_FILE get pods,svc -n ${env.TARGET_NS}
                        kubectl --kubeconfig \$KUBECONFIG_FILE rollout status deployment/fitverse-backend -n ${env.TARGET_NS}
                        kubectl --kubeconfig \$KUBECONFIG_FILE rollout status deployment/fitverse-frontend -n ${env.TARGET_NS}
                    """
                }
            }
        }
    }

    post {
        always {
            cleanWs()
        }
    }
}