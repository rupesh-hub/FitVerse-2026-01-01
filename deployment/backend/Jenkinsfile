@Library('Shared') _

pipeline {
    agent any

    tools {
       jdk 'Java17'
       maven 'maven-3'
    }

    environment {
        // Source code
        GIT_URL          = "https://github.com/rupesh-hub/FitVerse-2026-01-01.git"
        GIT_BRANCH       = "main"

        // Logical Paths
        PROJECT_PATH     = "backend"

        // Relative to PROJECT_PATH, the Dockerfile is one level up then in docker/
        DOCKERFILE_PATH  = "../docker/backend/Dockerfile"

        // Registry & Tools
        DOCKERHUB_REPO   = "rupesh1997/fitverse-backend"
        SONAR_API_ENV    = "SonarQube"

        // Other environment variables
        ACTIVE_PROFILE = "production"
    }

    stages {
        stage("Workspace Cleanup") {
            steps {
                cleanWs()
            }
        }

        stage('Checkout & Version Extraction') {
            steps {
                script {
                    // 1. Robust Checkout of the full repository
                    checkoutRepository(env.GIT_URL, env.GIT_BRANCH)

                    // 2. Extract version from backend/pom.xml
                    env.APP_VERSION = getVersion(env.PROJECT_PATH)
                    echo "Extracted Version: ${env.APP_VERSION}"
                }
            }
        }

        stage('Java: Build & Package') {
            steps {
                script {
                    // Professional practice: 'package' includes compilation and JAR creation
                    mavenExecute('clean package', env.PROJECT_PATH)
                }
            }
        }

        stage('Security & Quality Gates') {
            // Running these in parallel makes the pipeline significantly faster
            parallel {
                stage('SAST & SCA') {
                    steps {
                        dir("${env.PROJECT_PATH}") {
                            script {
                                // SonarQube for Code Quality
                                sonarScan(
                                    projectName: "fitverse-backend",
                                    projectKey:  "fitverse-backend-key",
                                    apiEnv: env.SONAR_API_ENV
                                )
                                // OWASP for Dependency Vulnerabilities
                                dependencyCheckScan(scanPath: '.', failThreshold: '7.0')
                            }
                        }
                    }
                }
                stage('Trivy: Filesystem') {
                    steps {
                        script {
                            // Scans the source code directory for hardcoded secrets/vulns
                            trivyFsScan(env.PROJECT_PATH)
                        }
                    }
                }
            }
        }

        stage("Docker: Build Image") {
            steps {
                dir("${env.PROJECT_PATH}") {
                    script {
                        def tags = ["latest", env.APP_VERSION]
                        def buildParams = [
                            'PROJECT_VERSION': env.APP_VERSION,
                            'ACTIVE_PROFILE' : env.ACTIVE_PROFILE
                        ]

                        // Points to the Dockerfile in ../docker/backend/Dockerfile
                        dockerBuild(env.DOCKERHUB_REPO, tags, buildParams, env.DOCKERFILE_PATH)
                    }
                }
            }
        }

        stage('Trivy: Image Scan') {
            steps {
                script {
                    // Final Gate: Scan the built image before it reaches the registry
                    trivyScan(["${env.DOCKERHUB_REPO}:${env.APP_VERSION}"])
                }
            }
        }

        stage("Docker: Push") {
            steps {
               script {
                  def pushList = ["${env.DOCKERHUB_REPO}:latest", "${env.DOCKERHUB_REPO}:${env.APP_VERSION}"]
                  // Secure push using credentials handled in library
                  pushImages(pushList, "dockerhub")
               }
            }
        }
    }

    post {
         success {
            script {
                // Artifact Management
                archiveArtifacts artifacts: "${env.PROJECT_PATH}/target/*.jar", allowEmptyArchive: true
                archiveArtifacts artifacts: '**/dependency-check-report.xml', allowEmptyArchive: true

                // Call library notification
                notify('SUCCESS', 'dulalrupesh77@gmail.com')

                // Trigger Downstream CD Job
                build job: "FitVerse-CD", parameters: [
                    string(name: 'DOCKER_TAG', value: env.APP_VERSION),
                    string(name: 'SERVICE_NAME', value: 'backend')
                ]
            }
         }
         failure {
            script {
                notify('FAILURE', 'dulalrupesh77@gmail.com')
            }
         }
    }
}