@Library('Shared') _

pipeline {
    agent any

    tools {
       jdk 'Java17'
       maven 'maven-3'
    }

    environment {
        GIT_URL          = "https://github.com/rupesh-hub/FitVerse-2026-01-01.git"
        GIT_BRANCH       = "main"
        PROJECT_PATH     = "backend"
        DOCKERFILE_PATH  = "../docker/backend/Dockerfile"
        DOCKERHUB_REPO   = "rupesh1997/fitverse-backend"
        SONAR_API_ENV    = "SonarQube"
        ACTIVE_PROFILE   = "production"
    }

    stages {
        stage("Workspace Cleanup") {
            steps {
                cleanWs()
            }
        }

        stage('Checkout & Version Extraction') {
            steps {
                script {
                    checkoutRepository(env.GIT_URL, env.GIT_BRANCH)
                    env.APP_VERSION = getVersion(env.PROJECT_PATH)
                    echo "Extracted Version: ${env.APP_VERSION}"
                }
            }
        }

        stage('Java: Build & Package') {
            steps {
                script {
                    mavenExecute('clean package', env.PROJECT_PATH)
                }
            }
        }

        stage('Security Scanning') {
            steps {
                script {
                    // Since you only have one scan now, no need for 'parallel'
                    // This prevents syntax errors and potential hanging
                    trivyFsScan(env.PROJECT_PATH)
                }
            }
        }

        stage("Docker: Build Image") {
            steps {
                dir("${env.PROJECT_PATH}") {
                    script {
                        def tags = ["latest", env.APP_VERSION]
                        def buildParams = [
                            'PROJECT_VERSION': env.APP_VERSION,
                            'ACTIVE_PROFILE' : env.ACTIVE_PROFILE
                        ]
                        dockerBuild(env.DOCKERHUB_REPO, tags, buildParams, env.DOCKERFILE_PATH)
                    }
                }
            }
        }

        stage('Trivy: Image Scan') {
            steps {
                script {
                    trivyImageScan(["${env.DOCKERHUB_REPO}:${env.APP_VERSION}"])
                }
            }
        }

        stage("Docker: Push") {
            steps {
               script {
                  def pushList = ["${env.DOCKERHUB_REPO}:latest", "${env.DOCKERHUB_REPO}:${env.APP_VERSION}"]
                  pushImages(pushList, "dockerhub")
               }
            }
        }
    }

    post {
         success {
            script {
                archiveArtifacts artifacts: "${env.PROJECT_PATH}/target/*.jar", allowEmptyArchive: true
                // Note: dependency-check-report will only exist if you run that scan
                archiveArtifacts artifacts: '**/dependency-check-report.xml', allowEmptyArchive: true

                notify('SUCCESS', 'dulalrupesh77@gmail.com')

                // Downstream CD Job (Ensure this job name exists in Jenkins)
                catchError(buildStepFailure: 'FAILURE', stageResult: 'FAILURE') {
                    build job: "FitVerse-CD", parameters: [
                        string(name: 'DOCKER_TAG', value: env.APP_VERSION),
                        string(name: 'SERVICE_NAME', value: 'backend')
                    ]
                }
            }
         }
         failure {
            script {
                notify('FAILURE', 'dulalrupesh77@gmail.com')
            }
         }
    }
}